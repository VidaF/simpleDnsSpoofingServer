#include "dnsSpoofing.h"

/******************************************
 * Input: which function is generating the error
 * Output: VOID                                        
 ******************************************/
static inline void errorMsg(const char *location)
{
	perror(location);
//	exit(1);
}

#define SERVER "127.0.0.1"
//if this number is increased, the sendBuf[][]  initialization should be changed too

#define NUMBER_OF_TESTS1   9
#define NUMBER_OF_TESTS2   3

uint8_t  sendBuf[NUMBER_OF_TESTS1][46] = {
/* header flags 0x01 0x20 *//*pass*/
{0x7d,  0xe5,  0x01,  0x20,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0xff 0xff *//*fail*/
{0x7d,  0xe5,  0xff,  0xff,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0x0 0x0 *//*pass*/
{0x7d,  0xe5,  0x0,  0x0,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0x10  0x0 *//*pass*/
{0x7d,  0xe5,  0x10,  0x0,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0x00 0x10 *//*pass*/
{0x7d,  0xe5,  0x0,  0x10,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0x80 0x80 *//*fail*/
{0x7d,  0xe5,  0x80,  0x80,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0x80 0x00 *//*fail*/
{0x7d,  0xe5,  0x80,  0x0,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* header flags 0x0 0x80 *//*pass*/
{0x7d,  0xe5,  0x0,  0x80,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* qType 0x00 0x00   *//*fail*/
{0x7d,  0xe5,  0x0,  0x0,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x0,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

};
uint8_t  sendBuf1[NUMBER_OF_TESTS2][50] = {
/* name: www.www.example.com *//*pass*/
{0x7d,  0xe5,  0x00,  0x00,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77, 0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* name: www.example.www.com*//*pass*/
{0x7d,  0xe5,  0x00,  0x00,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x3,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65, 0x3,  0x77,  0x77,  0x77,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0},

/* name: corrupted packet: (0x77)www7example3www3com0*//*fail*/
{0x7d,  0xe5,  0x00,  0x00,  0x0,  0x1,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0x77,  0x77,  0x77,  0x77,  0x7,  0x65,  0x78,  0x61,  0x6d,  0x70,  0x6c,  0x65, 0x3,  0x77,  0x77,  0x77,  0x3,  0x63,  0x6f,  0x6d,  0x0,  0x0,  0x1,  0x0,  0x1,  0x0,  0x0,  0x29,  0x10,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0}
};

/*****************************************
 * Sending packets to the socket
 * Input 1:  socket number
 * Input 2:  pointer to the TX buffer
 * Input 3:  Length of TX buffer
 *****************************************/

static void sendSocket (int socketNum, uint8_t *const inBuf, int32_t len, struct sockaddr_in *const cSocketInfo, socklen_t slen){

        if (sendto(socketNum, inBuf, len , 0 , (struct sockaddr *) cSocketInfo, slen)==-1) {
	   errorMsg("sendto()");
        }
}
/*****************************************
 
 *****************************************/

int main(void)
{
	struct sockaddr_in cSocketInfo;
	int socketNum;
        socklen_t len = sizeof(cSocketInfo);
	uint8_t buf[BUF_LEN];
        uint32_t recvLen;
        uint32_t pktLen;
        /* set socket timeout to 10 seconds */
        struct timeval timeout={10,0};
	if ( (socketNum = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == -1)
	{
		errorMsg("Socket");
                exit(1);
	}

	memset((char *) &cSocketInfo, 0, sizeof(cSocketInfo));
	cSocketInfo.sin_family = AF_INET;
	cSocketInfo.sin_port = htons(PORT_NUM);
	
	if (inet_aton(SERVER , &cSocketInfo.sin_addr) == 0) 
	{
		printf("client socket address error\n");
		exit(1);
	}
        for (int i = 0; i < NUMBER_OF_TESTS1 + NUMBER_OF_TESTS2; i++) 
	{
                if (i < NUMBER_OF_TESTS1) {

                    pktLen = 46;
                    sendSocket(socketNum, sendBuf[i], pktLen, &cSocketInfo, len);

                } else {
                    
                    pktLen = 50;
                    sendSocket(socketNum, sendBuf1[i - NUMBER_OF_TESTS1], pktLen, &cSocketInfo, len);
                   
                }
                /* set receive UDP message timeout */
                setsockopt(socketNum, SOL_SOCKET, SO_RCVTIMEO, (char*)&timeout, sizeof(struct timeval));
		memset(buf,0 , BUF_LEN);
		if ((recvLen = recvfrom(socketNum, buf, BUF_LEN, 0, (struct sockaddr *) &cSocketInfo, &len)) == -1) {
		
                    printf("\nRequest %i Failed.", i);
                    errorMsg("recvfrom()");

                /* check error cases for a received response */
		} else {
                    if (recvLen < 12 + 3 + 4 + 6  + 4){
                       
                         printf("\nRequest %i faild:: packet is too short", i);
                       
                    } else if ((buf[recvLen - 1] != 0x6) || (buf[recvLen - 2] != 0x6) || (buf[recvLen - 3] != 0x6) || (buf[recvLen - 4] != 0x6)){
                       
                          printf("\nRequest %i faild:: return address is not correct", i);
     
                    } else if ((buf[2] & 0x80) == 0) {

                          printf("\nRequest %i faild:: recived packet is not a Response packet", i);

                    /* TODO: check for more fields */
                    } else {

                          printf("\nRequest %i Passed:: Response:", i);
                    }
                    dumpBuffer(buf, recvLen);
         
                }
	}
        printf("\n");
	close(socketNum);
	return 0;
}

